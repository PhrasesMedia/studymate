<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>StudyMate - Learn at Your Pace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    
    :root {
      --linkedin-blue: #0073b1;
      --hover-blue: #005885;
      --bg-gray: #f3f2ef;
      --border-gray: #d9d9d9;
      --text-primary: #000000de;
      --text-secondary: #00000099;
      --card-shadow: 0 0 0 1px rgba(0,0,0,.08), 0 2px 4px rgba(0,0,0,.08);
      --card-hover: 0 0 0 1px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.12);
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", "Fira Sans", Ubuntu, Oxygen, "Oxygen Sans", Cantarell, "Droid Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Lucida Grande", Helvetica, Arial, sans-serif;
      background: var(--bg-gray);
      color: var(--text-primary);
    }

    /* Top Navigation */
    .topnav {
      background: #fff;
      border-bottom: 1px solid var(--border-gray);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 20px;
      color: var(--linkedin-blue);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--linkedin-blue);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }

    .nav-actions {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--linkedin-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--hover-blue);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--linkedin-blue);
      color: var(--linkedin-blue);
    }

    .btn-secondary:hover {
      background: rgba(0, 115, 177, 0.08);
    }

    .user-menu {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--linkedin-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
    }

    /* Layout */
    .container {
      display: flex;
      max-width: 1440px;
      margin: 0 auto;
      gap: 24px;
      padding: 24px;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      flex-shrink: 0;
    }

    .sidebar-section {
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-gray);
    }

    .sidebar-item {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .sidebar-item:hover {
      background: rgba(0,0,0,0.04);
    }

    .sidebar-item.active {
      background: rgba(0, 115, 177, 0.08);
      color: var(--linkedin-blue);
      font-weight: 600;
      border-left: 3px solid var(--linkedin-blue);
    }

    .sidebar-icon {
      font-size: 18px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      min-width: 0;
    }

    .page-header {
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      padding: 24px;
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 400;
      margin: 0 0 8px 0;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 0;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background: rgba(0, 115, 177, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-content h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 400;
      color: var(--text-secondary);
    }

    .stat-content p {
      margin: 4px 0 0 0;
      font-size: 24px;
      font-weight: 600;
    }

    /* Course Grid */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .filter-tabs {
      display: flex;
      gap: 8px;
      background: white;
      border-radius: 8px;
      padding: 4px;
      box-shadow: var(--card-shadow);
      margin-bottom: 16px;
    }

    .filter-tab {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .filter-tab.active {
      background: rgba(0, 115, 177, 0.1);
      color: var(--linkedin-blue);
    }

    .course-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .course-card {
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
    }

    .course-card:hover {
      box-shadow: var(--card-hover);
      transform: translateY(-2px);
    }

    .course-thumbnail {
      width: 100%;
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
    }

    .course-duration {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .course-content {
      padding: 16px;
    }

    .course-type {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .course-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 8px 0;
      line-height: 1.3;
    }

    .course-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .course-meta-dot {
      width: 3px;
      height: 3px;
      background: var(--text-secondary);
      border-radius: 50%;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: var(--linkedin-blue);
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .course-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 8px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.24);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-gray);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-gray);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-gray);
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--linkedin-blue);
      box-shadow: 0 0 0 3px rgba(0, 115, 177, 0.1);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 100px;
    }

    .error-message {
      background: #fff4f4;
      border: 1px solid #ffcdd2;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
      color: #c62828;
      font-size: 14px;
    }

    /* Player View */
    .player-container {
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .video-wrapper {
      aspect-ratio: 16/9;
      background: #000;
      position: relative;
    }

    .video-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
    }

    .player-controls {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-gray);
    }

    .player-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .player-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .lesson-list {
      padding: 16px;
    }

    .lesson-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 4px;
    }

    .lesson-item:hover {
      background: rgba(0,0,0,0.04);
    }

    .lesson-item.active {
      background: rgba(0, 115, 177, 0.08);
    }

    .lesson-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-gray);
      border-radius: 4px;
      flex-shrink: 0;
    }

    .lesson-checkbox.checked {
      background: var(--linkedin-blue);
      border-color: var(--linkedin-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }

    .lesson-info {
      flex: 1;
      min-width: 0;
    }

    .lesson-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .lesson-duration {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }

    .empty-text {
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        padding: 16px;
      }

      .sidebar {
        width: 100%;
      }

      .course-grid {
        grid-template-columns: 1fr;
      }

      .stats-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="topnav">
    <div class="logo">
      <div class="logo-icon">S</div>
      <span>StudyMate</span>
    </div>
    <div class="nav-actions">
      <button class="btn btn-secondary" id="signOutBtn">Sign Out</button>
      <div class="user-menu">U</div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-header">Navigation</div>
        <div class="sidebar-item active" data-view="my-courses">
          <span class="sidebar-icon">üìö</span>
          <span>My Courses</span>
        </div>
        <div class="sidebar-item" data-view="in-progress">
          <span class="sidebar-icon">‚ñ∂Ô∏è</span>
          <span>In Progress</span>
        </div>
        <div class="sidebar-item" data-view="completed">
          <span class="sidebar-icon">‚úÖ</span>
          <span>Completed</span>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-header">Library</div>
        <div class="sidebar-item">
          <span class="sidebar-icon">‚¨áÔ∏è</span>
          <span>Import</span>
        </div>
        <div class="sidebar-item">
          <span class="sidebar-icon">‚¨ÜÔ∏è</span>
          <span>Export</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- This will be dynamically populated -->
    </main>
  </div>

  <!-- Login Modal -->
  <div class="modal-backdrop open" id="loginModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Welcome to StudyMate</h2>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Sign in to sync your courses across devices</p>
        
        <div id="authError" class="error-message" style="display: none;"></div>
        
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="authEmail" placeholder="your@email.com" />
        </div>
        
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="guestBtn">Continue as Guest</button>
        <button class="btn btn-secondary" id="signupBtn">Create Account</button>
        <button class="btn btn-primary" id="loginBtn">Sign In</button>
      </div>
    </div>
  </div>

  <!-- Add Course Modal -->
  <div class="modal-backdrop" id="addCourseModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Create New Course</h2>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Course Title</label>
          <input type="text" class="form-input" id="newCourseTitle" placeholder="e.g., Introduction to Python Programming" />
        </div>
        
        <div class="form-group">
          <label class="form-label">YouTube URLs (one per line)</label>
          <textarea class="form-input" id="newCourseUrls" placeholder="https://youtube.com/watch?v=...
https://youtube.com/watch?v=..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelCourseBtn">Cancel</button>
        <button class="btn btn-primary" id="saveCourseBtn">Create Course</button>
      </div>
    </div>
  </div>

<script type="module">
  // Firebase imports
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBsE9NRAyzHtxg_ffN4AJK8hO3wp971MlY",
    authDomain: "study-mate-eed8f.firebaseapp.com",
    projectId: "study-mate-eed8f",
    storageBucket: "study-mate-eed8f.firebasestorage.app",
    messagingSenderId: "977101066516",
    appId: "1:977101066516:web:84d3162b5ff954430a3201"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const LIB_KEY = "study_mate_library_v1";
  let USER_ID = null;
  let lib = { activeId: "", courses: [] };

  // Utility functions
  function uid() {
    return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
  }

  function extractVideoId(url) {
    try {
      const u = new URL(url.trim());
      if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
      if (u.searchParams.get("v")) return u.searchParams.get("v");
      if (u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2];
      return null;
    } catch {
      return null;
    }
  }

  function formatDuration(totalMinutes) {
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    if (hours > 0) return `${hours}h ${minutes}m`;
    return `${minutes}m`;
  }

  function getCourseProgress(course) {
    const lessons = (course.modules || []).flatMap(m => m.lessons || []);
    const total = lessons.length;
    const completed = lessons.filter(l => l.completed).length;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    return { total, completed, percentage };
  }

  // Firebase sync
  async function syncToFirebase() {
    if (!db || !USER_ID) return;
    try {
      const userDocRef = doc(db, "users", USER_ID);
      await setDoc(userDocRef, {
        library: lib,
        lastSync: serverTimestamp()
      });
      console.log("‚úÖ Synced to Firebase");
    } catch (error) {
      console.error("‚ùå Firebase sync error:", error);
    }
  }

  async function loadFromFirebase() {
    if (!db || !USER_ID) return null;
    try {
      const userDocRef = doc(db, "users", USER_ID);
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        return docSnap.data().library;
      }
      return null;
    } catch (error) {
      console.error("‚ùå Firebase load error:", error);
      return null;
    }
  }

  function saveLib() {
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
    syncToFirebase();
  }

  // Authentication
  const loginModal = document.getElementById('loginModal');
  const authEmail = document.getElementById('authEmail');
  const authPassword = document.getElementById('authPassword');
  const authError = document.getElementById('authError');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const guestBtn = document.getElementById('guestBtn');

  function showAuthError(message) {
    authError.textContent = message;
    authError.style.display = 'block';
  }

  function hideAuthError() {
    authError.style.display = 'none';
  }

  loginBtn.addEventListener('click', async () => {
    hideAuthError();
    const email = authEmail.value.trim();
    const password = authPassword.value;
    
    if (!email || !password) {
      showAuthError('Please enter email and password');
      return;
    }

    try {
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      showAuthError(error.message || 'Sign in failed');
      loginBtn.disabled = false;
      loginBtn.textContent = 'Sign In';
    }
  });

  signupBtn.addEventListener('click', async () => {
    hideAuthError();
    const email = authEmail.value.trim();
    const password = authPassword.value;
    
    if (!email || !password) {
      showAuthError('Please enter email and password');
      return;
    }

    if (password.length < 6) {
      showAuthError('Password must be at least 6 characters');
      return;
    }

    try {
      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating account...';
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (error) {
      showAuthError(error.message || 'Account creation failed');
      signupBtn.disabled = false;
      signupBtn.textContent = 'Create Account';
    }
  });

  guestBtn.addEventListener('click', async () => {
    hideAuthError();
    try {
      guestBtn.disabled = true;
      guestBtn.textContent = 'Loading...';
      await signInAnonymously(auth);
    } catch (error) {
      showAuthError('Guest login failed');
      guestBtn.disabled = false;
      guestBtn.textContent = 'Continue as Guest';
    }
  });

  // Auth state listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      USER_ID = user.uid;
      loginModal.classList.remove('open');
      
      const firebaseLib = await loadFromFirebase();
      if (firebaseLib) {
        lib = firebaseLib;
      } else {
        const localLib = localStorage.getItem(LIB_KEY);
        if (localLib) {
          lib = JSON.parse(localLib);
        }
        await syncToFirebase();
      }
      
      renderCourses();
    } else {
      loginModal.classList.add('open');
    }
  });

  // Sign out
  document.getElementById('signOutBtn').addEventListener('click', async () => {
    try {
      await signOut(auth);
      lib = { activeId: "", courses: [] };
      localStorage.clear();
    } catch (error) {
      alert('Failed to sign out');
    }
  });

  // Render functions
  function renderCourses() {
    const mainContent = document.getElementById('mainContent');
    const courses = lib.courses || [];

    if (courses.length === 0) {
      mainContent.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üìö</div>
          <h2 class="empty-title">No courses yet</h2>
          <p class="empty-text">Create your first course to start learning</p>
          <button class="btn btn-primary" id="createFirstCourseBtn">Create Course</button>
        </div>
      `;
      
      document.getElementById('createFirstCourseBtn').addEventListener('click', openAddCourseModal);
      return;
    }

    const inProgress = courses.filter(c => {
      const { completed, total } = getCourseProgress(c);
      return completed < total && completed > 0;
    });

    const notStarted = courses.filter(c => {
      const { completed } = getCourseProgress(c);
      return completed === 0;
    });

    const completed = courses.filter(c => {
      const { completed, total } = getCourseProgress(c);
      return completed === total && total > 0;
    });

    mainContent.innerHTML = `
      <div class="page-header">
        <h1 class="page-title">My Content</h1>
        <p class="page-subtitle">Continue your learning journey</p>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon">üìö</div>
          <div class="stat-content">
            <h3>Total Courses</h3>
            <p>${courses.length}</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚ñ∂Ô∏è</div>
          <div class="stat-content">
            <h3>In Progress</h3>
            <p>${inProgress.length}</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <h3>Completed</h3>
            <p>${completed.length}</p>
          </div>
        </div>
      </div>

      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">All Courses</button>
        <button class="filter-tab" data-filter="progress">In Progress</button>
        <button class="filter-tab" data-filter="completed">Completed</button>
      </div>

      <div class="section-header">
        <h2 class="section-title">Courses</h2>
        <button class="btn btn-primary" id="addCourseBtn">+ Create Course</button>
      </div>

      <div class="course-grid" id="courseGrid"></div>
    `;

    document.getElementById('addCourseBtn').addEventListener('click', openAddCourseModal);
    
    renderCourseGrid(courses);
  }

  function renderCourseGrid(courses) {
    const grid = document.getElementById('courseGrid');
    grid.innerHTML = '';

    courses.forEach(course => {
      const { total, completed, percentage } = getCourseProgress(course);
      const totalMinutes = total * 5; // Assuming 5 min per lesson

      const gradients = [
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
      ];
      
      const gradient = gradients[courses.indexOf(course) % gradients.length];

      const card = document.createElement('div');
      card.className = 'course-card';
      card.innerHTML = `
        <div class="course-thumbnail" style="background: ${gradient};">
          üìö
          <span class="course-duration">${formatDuration(totalMinutes)}</span>
        </div>
        <div class="course-content">
          <div class="course-type">Course</div>
          <h3 class="course-title">${course.title || 'Untitled Course'}</h3>
          <div class="course-meta">
            <span>${total} lessons</span>
            <span class="course-meta-dot"></span>
            <span>${course.modules?.length || 0} modules</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%"></div>
          </div>
          <div class="progress-text">${completed} of ${total} lessons complete</div>
          <div class="course-actions">
            <button class="btn btn-primary btn-small">Continue</button>
            <button class="btn btn-secondary btn-small">‚ãØ</button>
          </div>
        </div>
      `;

      card.querySelector('.btn-primary').addEventListener('click', (e) => {
        e.stopPropagation();
        openCourse(course.id);
      });

      grid.appendChild(card);
    });
  }

  function openCourse(courseId) {
    lib.activeId = courseId;
    const course = lib.courses.find(c => c.id === courseId);
    if (!course) return;

    const lessons = (course.modules || []).flatMap(m => m.lessons || []);
    const { total, completed, percentage } = getCourseProgress(course);
    
    // Find the lesson to play (last played or first incomplete)
    let playingLesson = null;
    if (course.lastLessonId) {
      playingLesson = lessons.find(l => l.id === course.lastLessonId);
    }
    if (!playingLesson) {
      playingLesson = lessons.find(l => !l.completed) || lessons[0];
    }

    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = `
      <div style="margin-bottom: 16px;">
        <button class="btn btn-secondary" id="backToCoursesBtn">‚Üê Back to Courses</button>
      </div>

      <div class="player-container">
        <div class="video-wrapper" id="videoWrapper">
          ${playingLesson && playingLesson.videoId ? 
            `<iframe src="https://www.youtube.com/embed/${playingLesson.videoId}?rel=0" 
                     allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                     allowfullscreen></iframe>` :
            `<div class="video-placeholder">
              <div style="font-size: 48px; margin-bottom: 16px;">üì∫</div>
              <div>Select a lesson to start watching</div>
            </div>`
          }
        </div>

        <div class="player-controls">
          <h2 class="player-title">${course.title || 'Untitled Course'}</h2>
          <div class="player-meta">
            <span>${completed} of ${total} lessons complete</span>
            <span>‚Ä¢</span>
            <span>${percentage}% complete</span>
          </div>
        </div>

        <div class="lesson-list" id="lessonList"></div>
      </div>
    `;

    document.getElementById('backToCoursesBtn').addEventListener('click', renderCourses);

    renderLessonList(course, playingLesson);
  }

  function renderLessonList(course, currentLesson) {
    const lessonListEl = document.getElementById('lessonList');
    lessonListEl.innerHTML = '';

    (course.modules || []).forEach((module, moduleIndex) => {
      if (module.lessons && module.lessons.length > 0) {
        // Module header
        const moduleHeader = document.createElement('div');
        moduleHeader.style.cssText = 'padding: 12px 16px; font-weight: 600; font-size: 14px; color: var(--text-secondary); background: rgba(0,0,0,0.02);';
        moduleHeader.textContent = `${moduleIndex + 1}. ${module.title || 'Module'}`;
        lessonListEl.appendChild(moduleHeader);

        // Lessons
        module.lessons.forEach((lesson, lessonIndex) => {
          const isActive = currentLesson && currentLesson.id === lesson.id;
          
          const lessonItem = document.createElement('div');
          lessonItem.className = 'lesson-item' + (isActive ? ' active' : '');
          
          lessonItem.innerHTML = `
            <div class="lesson-checkbox ${lesson.completed ? 'checked' : ''}">
              ${lesson.completed ? '‚úì' : ''}
            </div>
            <div class="lesson-info">
              <div class="lesson-title">${lessonIndex + 1}. ${lesson.title || 'Lesson'}</div>
              <div class="lesson-duration">${lesson.videoId ? 'Video ID: ' + lesson.videoId : 'No video'}</div>
            </div>
            <button class="btn btn-small ${isActive ? 'btn-secondary' : 'btn-primary'}">
              ${isActive ? 'Playing' : 'Play'}
            </button>
          `;

          lessonItem.querySelector('.lesson-checkbox').addEventListener('click', (e) => {
            e.stopPropagation();
            lesson.completed = !lesson.completed;
            saveLib();
            openCourse(course.id);
          });

          lessonItem.querySelector('.btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (lesson.videoId) {
              course.lastLessonId = lesson.id;
              lesson.watched = true;
              saveLib();
              openCourse(course.id);
            }
          });

          lessonItem.addEventListener('click', () => {
            if (lesson.videoId) {
              course.lastLessonId = lesson.id;
              lesson.watched = true;
              saveLib();
              openCourse(course.id);
            }
          });

          lessonListEl.appendChild(lessonItem);
        });
      }
    });
  }

  // Add Course Modal
  const addCourseModal = document.getElementById('addCourseModal');

  function openAddCourseModal() {
    addCourseModal.classList.add('open');
  }

  document.getElementById('cancelCourseBtn').addEventListener('click', () => {
    addCourseModal.classList.remove('open');
  });

  document.getElementById('saveCourseBtn').addEventListener('click', () => {
    const title = document.getElementById('newCourseTitle').value.trim();
    const urls = document.getElementById('newCourseUrls').value.split('\n')
      .map(u => u.trim())
      .filter(Boolean);

    if (!title) {
      alert('Please enter a course title');
      return;
    }

    const lessons = urls.map(url => {
      const videoId = extractVideoId(url);
      return {
        id: uid(),
        videoId: videoId || '',
        url: url,
        title: 'Lesson',
        completed: false,
        watched: false,
        understood: false,
        notes: ''
      };
    });

    const newCourse = {
      id: uid(),
      title: title,
      lastLessonId: '',
      modules: [{
        id: uid(),
        title: 'Module 1',
        lessons: lessons
      }]
    };

    lib.courses = [newCourse, ...(lib.courses || [])];
    lib.activeId = newCourse.id;
    saveLib();
    
    addCourseModal.classList.remove('open');
    document.getElementById('newCourseTitle').value = '';
    document.getElementById('newCourseUrls').value = '';
    
    renderCourses();
  });
</script>
</body>
</html>