<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Study Mate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#070b16;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --border: rgba(255,255,255,.14);
      --shadow: 0 20px 70px rgba(0,0,0,.55);

      --accent: #7c3aed;
      --accent2:#2563eb;
      --danger: #ef4444;
      --good: #22c55e;

      --r-xl: 22px;
      --r: 16px;
      --r-sm: 12px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 520px at 12% 12%, rgba(124,58,237,.28), transparent 60%),
        radial-gradient(900px 520px at 90% 18%, rgba(37,99,235,.22), transparent 55%),
        radial-gradient(700px 420px at 55% 95%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      padding: 18px 14px;
    }

    .shell{
      max-width: 1240px;
      margin: 0 auto;
      border: 1px solid var(--border);
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow: hidden;
      min-height: calc(100vh - 36px);
      display: grid;
      grid-template-columns: 340px 1fr;
    }

    /* Sidebar */
    .sidebar{
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,.10);
      display:flex;
      flex-direction: column;
      min-width: 0;
    }

    .sideTop{
      padding: 16px 14px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .logo{
      width: 36px; height: 36px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 30px rgba(124,58,237,.22);
      flex: 0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      letter-spacing: -0.01em;
      line-height: 1.1;
    }
    .brand p{
      margin:2px 0 0;
      color: var(--muted);
      font-size: 12px;
    }

    .btn{
      appearance:none;
      border: 1px solid transparent;
      cursor: pointer;
      border-radius: 14px;
      padding: 10px 12px;
      color: #fff;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .01em;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 32px rgba(124,58,237,.14);
      transition: transform .12s ease, filter .12s ease;
      white-space: nowrap;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px) scale(.99); }

    .btnGhost{
      background: rgba(255,255,255,.08);
      border-color: var(--border);
      box-shadow: none;
      font-weight: 800;
    }

    .btnDanger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
      color: rgba(255,255,255,.92);
      box-shadow: none;
    }

    .sideBody{
      padding: 12px 14px;
      display: grid;
      gap: 10px;
      overflow:auto;
      min-height: 0;
    }

    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: .01em;
    }

    input, textarea, select{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size: 13px;
      resize: vertical;
    }
    textarea{ min-height: 92px; }

    .courseList{
      display: grid;
      gap: 10px;
    }

    .courseRow{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.10);
      display:flex;
      gap: 10px;
      align-items: start;
      justify-content: space-between;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
      position: relative;
    }
    .courseRow:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
    }
    .courseRow.active{
      background: rgba(124,58,237,.12);
      border-color: rgba(124,58,237,.45);
    }

    .courseLeft{
      min-width: 0;
      flex: 1;
    }
    .courseName{
      font-weight: 900;
      font-size: 13px;
      letter-spacing: -0.01em;
      margin-bottom: 6px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .courseMeta{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 999px;
      padding: 4px 8px;
      white-space: nowrap;
    }

    .progressWrap{
      margin-top: 8px;
      display:flex;
      gap: 8px;
      align-items:center;
      color: rgba(255,255,255,.78);
      font-size: 12px;
    }
    .bar{
      flex: 1;
      height: 8px;
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      overflow:hidden;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--good), var(--accent));
    }

    .menuWrap{
      position: relative;
      flex: 0 0 auto;
    }

    .kebab{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.86);
      border-radius: 12px;
      padding: 6px 8px;
      cursor:pointer;
      font-weight: 900;
      line-height: 1;
    }

    .menu{
      position:absolute;
      right: 0;
      top: 38px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,12,22,.96);
      border-radius: 14px;
      padding: 6px;
      display:none;
      min-width: 160px;
      z-index: 5;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .menu.open{ display:block; }
    .menu button{
      width:100%;
      text-align:left;
      padding: 10px 10px;
      border-radius: 12px;
      border: 0;
      background: transparent;
      color: rgba(255,255,255,.88);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .menu button:hover{ background: rgba(255,255,255,.08); }
    .menu .danger{ color: rgba(255,120,120,.95); }

    .sideFooter{
      border-top: 1px solid var(--border);
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .muted{ color: var(--muted); font-size: 12px; }

    /* Main */
    .main{
      min-width: 0;
      display:flex;
      flex-direction: column;
      background: rgba(0,0,0,.06);
    }

    .mainHeader{
      border-bottom: 1px solid var(--border);
      padding: 16px 16px 14px;
      display:flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .mainHeaderLeft{
      min-width: 260px;
    }
    .mainHeader h2{
      margin: 0;
      font-size: 18px;
      letter-spacing: -0.02em;
    }
    .mainHeader p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      max-width: 640px;
      line-height: 1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: rgba(255,255,255,.84);
      white-space: nowrap;
    }

    .content{
      padding: 14px 16px 18px;
      overflow:auto;
      min-height: 0;
    }

    /* Player */
    .player{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--r-xl);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    .playerTop{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .playerTopLeft .title{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }
    .playerTopLeft .sub{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }

    .miniBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.10); }
    .miniPrimary{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-color: transparent;
      box-shadow: 0 14px 40px rgba(124,58,237,.12);
    }
    .miniDisabled{
      opacity: .42;
      pointer-events:none;
    }

    .playerFrame{
      position: relative;
      background: #000;
      width: 100%;
      aspect-ratio: 16/9;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .playerFrame iframe{
      width: 100%;
      height: 100%;
      border: 0;
    }
    .playerEmpty{
      color: rgba(255,255,255,.78);
      font-weight: 800;
      font-size: 13px;
      padding: 16px;
      text-align:center;
      line-height: 1.3;
    }

    .playerNotes{
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      display:grid;
      gap: 10px;
    }

    .notesHeader{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .notesHeader .left{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .trophy{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      font-size: 12px;
      color: rgba(255,255,255,.82);
      white-space: nowrap;
    }
    .trophy small{ color: rgba(255,255,255,.62); font-weight: 800; }

    .playerList{
      padding: 12px;
      display:grid;
      gap: 10px;
    }

    .lessonPick{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease;
    }
    .lessonPick:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.16);
    }
    .lessonPick.active{
      background: rgba(124,58,237,.12);
      border-color: rgba(124,58,237,.45);
    }

    .lessonPickTitle{
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 6px;
      letter-spacing: -0.01em;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .lessonPickMeta{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
      align-items:center;
    }

    .miniLine{
      display:flex;
      gap: 8px;
      align-items:center;
      font-size: 12px;
      color: rgba(255,255,255,.82);
      font-weight: 900;
    }
    .miniLine input{ width: 16px; height: 16px; }

    /* Builder + Modules */
    .builderBar{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--r-xl);
      background: rgba(0,0,0,.14);
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .barRow{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      flex-wrap: wrap;
    }

    .modulesHeader{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .modulesHeader h3{
      margin: 0;
      font-size: 14px;
      letter-spacing: -0.01em;
    }

    .module{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--r-xl);
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    .moduleTop{
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .moduleTopLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
      flex: 1;
    }
    .moduleTitle{
      font-weight: 900;
      font-size: 13px;
      letter-spacing: -0.01em;
      min-width: 0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .moduleBody{
      padding: 12px;
      display:grid;
      gap: 10px;
    }

    .lessonRow{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }

    .lessonRowLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width:0;
    }
    .lessonRowTitle{
      min-width:0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 900;
      font-size: 13px;
    }
    .lessonRowSub{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items:center;
    }

    .lessonActions{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .iconBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }
    .iconBtn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.14);
    }

    .empty{
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: var(--r-xl);
      padding: 16px;
      text-align:center;
      color: rgba(255,255,255,.78);
      font-weight: 800;
      background: rgba(0,0,0,.10);
      margin-top: 12px;
    }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 18px;
      background: rgba(10,12,22,.96);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHeader h4{
      margin:0;
      font-size: 14px;
      letter-spacing: -0.01em;
    }
    .modalBody{
      padding: 14px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height: 1.35;
    }
    .modalActions{
      padding: 12px 14px 14px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .link{
      color: rgba(180,200,255,.96);
      text-decoration:none;
      font-weight: 900;
    }
    .link:hover{ text-decoration: underline; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(255,255,255,.78);
    }

    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ border-right: 0; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sideTop">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Course Library</h1>
            <p>Switch between courses</p>
          </div>
        </div>
        <button class="btn btnGhost" id="newCourseBtn">+ New</button>
      </div>

      <div class="sideBody">
        <div class="field">
          <label>Search courses</label>
          <input id="courseSearch" placeholder="e.g. Excel basics" />
        </div>

        <div class="courseList" id="courseList"></div>
      </div>

      <div class="sideFooter">
        <div class="muted" id="libraryMeta">0 courses</div>
        <div style="display:flex; gap:8px;">
          <button class="btn btnGhost" id="exportLibraryBtn">Export</button>
          <button class="btn btnGhost" id="importLibraryBtn">Import</button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="mainHeader">
        <div class="mainHeaderLeft">
          <h2 id="mainTitle">My Course</h2>
          <p>Build modules & lessons from YouTube links. Track completion. Click a lesson to watch.</p>
        </div>
        <div style="display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end;">
          <div class="pill" id="statsPill">0 modules â€¢ 0 lessons</div>
          <div class="pill" id="progressPill">0% complete</div>
          <button class="btn btnGhost" id="startWatchingBtn">Start / Resume</button>
          <button class="btn btnGhost" id="exportCourseBtn">Export course</button>
          <button class="btn btnDanger" id="deleteCourseBtn">Delete course</button>
        </div>
      </div>

      <div class="content">
        <!-- Player -->
        <div class="player" id="player">
          <div class="playerTop">
            <div class="playerTopLeft">
              <div class="title">Player</div>
              <div class="sub" id="playerSub">
                Pick a lesson to start watching.
              </div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end;">
              <button class="miniBtn btnGhost" id="prevBtn">Prev</button>
              <button class="miniBtn miniPrimary" id="nextBtn">Next</button>
            </div>
          </div>

          <div class="playerFrame" id="playerFrame">
            <div class="playerEmpty" id="playerEmpty">
              Add a lesson with a valid YouTube link, then click it below to watch here.
            </div>
          </div>

          <div class="playerNotes" id="playerNotes" style="display:none;">
            <div class="notesHeader">
              <div class="left">
                <div class="trophy" title="Bronze trophy is earned the first time you play this lesson.">
                  ðŸ¥‰ <strong>Bronze</strong> <small id="bronzeText">Not earned</small>
                </div>
                <div class="trophy" title="Silver trophy is earned when you click â€œI understand thisâ€.">
                  ðŸ¥ˆ <strong>Silver</strong> <small id="silverText">Not earned</small>
                </div>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="miniBtn miniPrimary" id="understandBtn">I understand this</button>
              </div>
            </div>

            <div class="field">
              <label>Notes for this lesson</label>
              <textarea id="notesBox" placeholder="Write your notes hereâ€¦"></textarea>
              <div class="muted" id="notesMeta" style="margin-top:8px;">Notes are saved automatically.</div>
            </div>
          </div>

          <div class="playerList" id="playerList"></div>
        </div>

        <!-- Builder -->
        <div class="builderBar" style="margin-top:12px;">
          <div class="field">
            <label>Course title</label>
            <input id="courseTitle" placeholder="e.g. Intro to Data Analysis (YouTube)" />
          </div>

          <div class="field">
            <label>Add YouTube links (adds to selected module)</label>
            <textarea id="urls" placeholder="Paste YouTube URLs (one per line)"></textarea>

            <div class="barRow" style="margin-top:10px;">
              <div class="field" style="flex: 1; min-width: 220px;">
                <label>Target module</label>
                <select id="moduleSelect"></select>
              </div>
              <button class="btn" id="addBtn">Add lessons</button>
              <button class="btn btnGhost" id="addModuleBtn">+ Module</button>
            </div>

            <div class="muted" style="margin-top:8px;">
              Tracking is stored in this browser (localStorage).
            </div>
          </div>
        </div>

        <div class="modulesHeader">
          <h3>Course outline</h3>
        </div>

        <div id="modules"></div>
        <div id="empty" class="empty" style="display:none;">
          Add a module, then paste YouTube links to start building your course.
        </div>
      </div>
    </main>
  </div>

  <!-- Confirm modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h4 id="modalTitle">Confirm</h4>
      </div>
      <div class="modalBody" id="modalBody">Are you sure?</div>
      <div class="modalActions">
        <button class="btn btnGhost" id="modalCancel">Cancel</button>
        <button class="btn btnDanger" id="modalConfirm">Delete</button>
      </div>
    </div>
  </div>

<script>
  const LIB_KEY = "study_mate_library_v1";

  const els = {
    // sidebar
    newCourseBtn: document.getElementById("newCourseBtn"),
    courseSearch: document.getElementById("courseSearch"),
    courseList: document.getElementById("courseList"),
    libraryMeta: document.getElementById("libraryMeta"),
    exportLibraryBtn: document.getElementById("exportLibraryBtn"),
    importLibraryBtn: document.getElementById("importLibraryBtn"),

    // header
    mainTitle: document.getElementById("mainTitle"),
    statsPill: document.getElementById("statsPill"),
    progressPill: document.getElementById("progressPill"),
    startWatchingBtn: document.getElementById("startWatchingBtn"),
    exportCourseBtn: document.getElementById("exportCourseBtn"),
    deleteCourseBtn: document.getElementById("deleteCourseBtn"),

    // player
    playerSub: document.getElementById("playerSub"),
    prevBtn: document.getElementById("prevBtn"),
    nextBtn: document.getElementById("nextBtn"),
    playerFrame: document.getElementById("playerFrame"),
    playerList: document.getElementById("playerList"),
    playerNotes: document.getElementById("playerNotes"),
    notesBox: document.getElementById("notesBox"),
    notesMeta: document.getElementById("notesMeta"),
    understandBtn: document.getElementById("understandBtn"),
    bronzeText: document.getElementById("bronzeText"),
    silverText: document.getElementById("silverText"),

    // builder
    courseTitle: document.getElementById("courseTitle"),
    urls: document.getElementById("urls"),
    moduleSelect: document.getElementById("moduleSelect"),
    addBtn: document.getElementById("addBtn"),
    addModuleBtn: document.getElementById("addModuleBtn"),
    modules: document.getElementById("modules"),
    empty: document.getElementById("empty"),

    // modal
    modalBack: document.getElementById("modalBack"),
    modalTitle: document.getElementById("modalTitle"),
    modalBody: document.getElementById("modalBody"),
    modalCancel: document.getElementById("modalCancel"),
    modalConfirm: document.getElementById("modalConfirm"),
  };

  // ---------- state ----------
  let lib = loadLib();
  let playingLessonId = "";
  let notesTimer = null;

  // ---------- utilities ----------
  function uid(){
    return Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  }

  function extractVideoId(url){
    try{
      const u = new URL(url.trim());
      if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
      if (u.searchParams.get("v")) return u.searchParams.get("v");
      if (u.pathname.startsWith("/shorts/")) return u.pathname.split("/")[2];
      return "";
    }catch{ return ""; }
  }

  function ytEmbed(videoId){
    return `https://www.youtube.com/embed/${encodeURIComponent(videoId)}`;
  }
  function ytWatch(videoId){
    return `https://www.youtube.com/watch?v=${encodeURIComponent(videoId)}`;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("`","&#096;");
  }

  function loadLib(){
    try{
      const raw = localStorage.getItem(LIB_KEY);
      const parsed = raw ? JSON.parse(raw) : null;
      return normalizeLib(parsed);
    }catch{
      return normalizeLib(null);
    }
  }

  function normalizeLib(raw){
    const base = { activeId: "", courses: [] };
    if (!raw || !Array.isArray(raw.courses)) return seedLib(base);

    const courses = raw.courses
      .filter(c => c && typeof c.title === "string" && Array.isArray(c.modules))
      .map(c => {
        const modules = (c.modules || [])
          .filter(m => m && typeof m.title === "string" && Array.isArray(m.lessons))
          .map(m => {
            const lessons = (m.lessons || [])
              .filter(les => les && (typeof les.url === "string" || typeof les.videoId === "string"))
              .map(les => {
                const url = typeof les.url === "string" ? les.url : "";
                const vid = typeof les.videoId === "string" ? les.videoId : extractVideoId(url);
                return {
                  id: typeof les.id === "string" ? les.id : uid(),
                  title: typeof les.title === "string" ? les.title : "Lesson",
                  url,
                  videoId: vid || "",
                  completed: !!les.completed,
                  watched: !!les.watched,
                  understood: !!les.understood,
                  notes: typeof les.notes === "string" ? les.notes : ""
                };
              });
            return {
              id: typeof m.id === "string" ? m.id : uid(),
              title: m.title,
              lessons
            };
          });

        return {
          id: typeof c.id === "string" ? c.id : uid(),
          title: c.title,
          lastLessonId: typeof c.lastLessonId === "string" ? c.lastLessonId : "",
          modules: modules.length ? modules : [{ id: uid(), title:"Module 1", lessons: [] }]
        };
      });

    const activeId = (typeof raw.activeId === "string" && courses.some(c => c.id === raw.activeId))
      ? raw.activeId
      : (courses[0]?.id || "");

    return { activeId, courses };
  }

  function seedLib(base){
    const first = makeCourse("Index.html");
    base.courses = [first, makeCourse("Cooking 101"), makeCourse("Parenting 101"), makeCourse("Landscaping 101")];
    base.activeId = base.courses[0].id;
    return base;
  }

  function makeCourse(title){
    return {
      id: uid(),
      title: title || "Untitled course",
      lastLessonId: "",
      modules: [{ id: uid(), title: "Module 1", lessons: [] }]
    };
  }

  function saveLib(){
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
    render();
  }

  // ---------- derived helpers ----------
  function activeCourse(){
    return (lib.courses || []).find(c => c.id === lib.activeId) || lib.courses[0] || makeCourse("My Course");
  }

  function flattenLessons(course){
    const out = [];
    (course?.modules || []).forEach(m => {
      (m.lessons || []).forEach(l => {
        out.push({
          moduleId: m.id,
          moduleTitle: m.title,
          lessonId: l.id,
          lesson: l
        });
      });
    });
    return out;
  }

  function courseStats(course){
    const flat = flattenLessons(course);
    const total = flat.length;
    const done = flat.filter(x => x.lesson.completed).length;
    const pct = total ? Math.round((done/total)*100) : 0;
    return { total, done, pct };
  }

  // ---------- modal ----------
  let modalResolve = null;
  function confirmModal(title, body, confirmText="Confirm"){
    els.modalTitle.textContent = title;
    els.modalBody.textContent = body;
    els.modalConfirm.textContent = confirmText;
    els.modalBack.classList.add("open");
    return new Promise(res => modalResolve = res);
  }
  function closeModal(value){
    els.modalBack.classList.remove("open");
    const r = modalResolve;
    modalResolve = null;
    if (r) r(value);
  }

  els.modalCancel.addEventListener("click", () => closeModal(false));
  els.modalBack.addEventListener("click", (e) => {
    if (e.target === els.modalBack) closeModal(false);
  });

  els.modalConfirm.addEventListener("click", () => closeModal(true));

  // ---------- library actions ----------
  function newCourse(){
    const c = makeCourse("New course");
    lib.courses = [c, ...lib.courses];
    lib.activeId = c.id;
    playingLessonId = "";
    saveLib();
  }

  function switchCourse(courseId){
    lib.activeId = courseId;
    playingLessonId = "";
    saveLib();
  }

  function renameCourse(courseId){
    const c = lib.courses.find(x => x.id === courseId);
    const title = prompt("Rename course", c?.title || "");
    if (title == null) return;
    lib.courses = lib.courses.map(x => x.id === courseId ? { ...x, title: title.trim() || "Untitled course" } : x);
    saveLib();
  }

  function duplicateCourse(courseId){
    const src = lib.courses.find(c => c.id === courseId);
    if (!src) return;

    const copy = {
      id: uid(),
      title: (src.title || "Untitled") + " (Copy)",
      lastLessonId: "",
      modules: (src.modules || []).map(m => ({
        id: uid(),
        title: m.title || "Module",
        lessons: (m.lessons || []).map(l => ({
          id: uid(),
          videoId: l.videoId || "",
          url: l.url || "",
          title: l.title || "Lesson",
          completed: !!l.completed,
          watched: !!l.watched,
          understood: !!l.understood,
          notes: typeof l.notes === "string" ? l.notes : ""
        }))
      }))
    };

    lib.courses = [copy, ...lib.courses];
    lib.activeId = copy.id;
    playingLessonId = "";
    saveLib();
  }

  async function deleteCourse(courseId){
    const c = lib.courses.find(x => x.id === courseId);
    if (!c) return;

    const ok = await confirmModal("Delete course?", `Delete "${c.title}" permanently?`, "Delete");
    if (!ok) return;

    lib.courses = lib.courses.filter(x => x.id !== courseId);
    if (!lib.courses.length){
      const n = makeCourse("My Course");
      lib.courses = [n];
      lib.activeId = n.id;
    }else if (lib.activeId === courseId){
      lib.activeId = lib.courses[0].id;
    }
    playingLessonId = "";
    saveLib();
  }

  function exportLibrary(){
    const blob = new Blob([JSON.stringify(lib, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "study_mate_library.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importLibrary(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.addEventListener("change", async () => {
      const file = input.files && input.files[0];
      if (!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || !Array.isArray(parsed.courses)) return;

        // Import supports older exports too (missing watched/understood/notes).
        const cleaned = {
          activeId: "",
          courses: parsed.courses
            .filter(c => c && typeof c.title === "string" && Array.isArray(c.modules))
            .map(c => ({
              id: uid(),
              title: c.title,
              lastLessonId: "",
              modules: c.modules
                .filter(m => m && typeof m.title === "string" && Array.isArray(m.lessons))
                .map(m => ({
                  id: uid(),
                  title: m.title,
                  lessons: m.lessons
                    .filter(l => l && typeof l.url === "string")
                    .map(l => ({
                      id: uid(),
                      url: l.url,
                      videoId: typeof l.videoId === "string" ? l.videoId : (extractVideoId(l.url) || ""),
                      title: typeof l.title === "string" ? l.title : "Lesson",
                      completed: !!l.completed,
                      watched: !!l.watched,
                      understood: !!l.understood,
                      notes: typeof l.notes === "string" ? l.notes : ""
                    }))
                }))
            }))
        };

        if (!cleaned.courses.length) return;
        cleaned.activeId = cleaned.courses[0].id;

        lib = normalizeLib(cleaned);
        playingLessonId = "";
        saveLib();
      }catch{}
    });
    input.click();
  }

  // ---------- course actions ----------
  function updateCourseTitle(title){
    lib.courses = lib.courses.map(c => c.id === lib.activeId ? { ...c, title } : c);
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
    renderHeaderOnly();
    renderSidebarOnly();
  }

  function addModule(){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      const mods = Array.isArray(c.modules) ? c.modules : [];
      return { ...c, modules: [...mods, { id: uid(), title: `Module ${mods.length + 1}`, lessons: [] }] };
    });
    saveLib();
  }

  function removeModule(moduleId){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      let mods = (c.modules || []).filter(m => m.id !== moduleId);
      if (!mods.length) mods = [{ id: uid(), title: "Module 1", lessons: [] }];
      return { ...c, modules: mods };
    });
    saveLib();
  }

  function moveModule(moduleId, dir){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      const mods = Array.isArray(c.modules) ? c.modules : [];
      const i = mods.findIndex(m => m.id === moduleId);
      const j = i + dir;
      if (i < 0 || j < 0 || j >= mods.length) return c;
      const next = [...mods];
      const item = next.splice(i, 1)[0];
      next.splice(j, 0, item);
      return { ...c, modules: next };
    });
    saveLib();
  }

  function updateModuleTitle(moduleId, title){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      return { ...c, modules: (c.modules || []).map(m => m.id === moduleId ? { ...m, title } : m) };
    });
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
    renderPlayerOnly();
    renderSidebarOnly();
  }

  function updateLesson(moduleId, lessonId, patch){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      return {
        ...c,
        modules: (c.modules || []).map(m => {
          if (m.id !== moduleId) return m;
          return { ...m, lessons: (m.lessons || []).map(l => l.id === lessonId ? { ...l, ...patch } : l) };
        })
      };
    });
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
    renderHeaderOnly();
    renderPlayerOnly();
    renderSidebarOnly();
  }

  function removeLesson(moduleId, lessonId){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      const next = {
        ...c,
        modules: (c.modules || []).map(m => m.id === moduleId ? { ...m, lessons: (m.lessons || []).filter(l => l.id !== lessonId) } : m)
      };

      if (next.lastLessonId === lessonId) next.lastLessonId = "";
      return next;
    });

    if (playingLessonId === lessonId) playingLessonId = "";
    saveLib();
  }

  function moveLesson(moduleId, lessonIndex, dir){
    lib.courses = lib.courses.map(c => {
      if (c.id !== lib.activeId) return c;
      return {
        ...c,
        modules: (c.modules || []).map(m => {
          if (m.id !== moduleId) return m;
          const lessons = Array.isArray(m.lessons) ? m.lessons : [];
          const j = lessonIndex + dir;
          if (j < 0 || j >= lessons.length) return m;
          const next = [...lessons];
          const item = next.splice(lessonIndex, 1)[0];
          next.splice(j, 0, item);
          return { ...m, lessons: next };
        })
      };
    });
    saveLib();
  }

  function addLessonsToModule(moduleId){
    const lines = els.urls.value.split("\n").map(s => s.trim()).filter(Boolean);
    if (!lines.length) return;

    const c = activeCourse();
    const module = (c.modules || []).find(m => m.id === moduleId);
    if (!module) return;

    const existingVideoIds = new Set((module.lessons || []).map(l => l.videoId));

    const toAdd = [];
    for (const line of lines){
      const vid = extractVideoId(line);
      if (!vid) continue;
      if (existingVideoIds.has(vid)) continue;
      toAdd.push({ id: uid(), videoId: vid, url: line.trim(), title: "New lesson", completed: false, watched: false, understood: false, notes: "" });
      existingVideoIds.add(vid);
    }
    if (!toAdd.length) return;

    lib.courses = lib.courses.map(course => {
      if (course.id !== lib.activeId) return course;
      return {
        ...course,
        modules: (course.modules || []).map(m => m.id === moduleId ? { ...m, lessons: [...(m.lessons || []), ...toAdd] } : m)
      };
    });

    els.urls.value = "";
    saveLib();
  }

  // ---------- player ----------
  function setPlaying(lessonId){
    const c = activeCourse();
    const flat = flattenLessons(c);
    const found = flat.find(x => x.lessonId === lessonId);
    if (!found || !found.lesson.videoId) return;

    playingLessonId = lessonId;

    // Bronze trophy: earn on first play
    if (!found.lesson.watched){
      updateLesson(found.moduleId, found.lessonId, { watched: true });
    }

    lib.courses = lib.courses.map(course => {
      if (course.id !== lib.activeId) return course;
      return { ...course, lastLessonId: lessonId };
    });
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
    renderPlayerOnly();
    renderSidebarOnly();
  }

  function resume(){
    const c = activeCourse();
    const flat = flattenLessons(c).filter(x => x.lesson.videoId);
    if (!flat.length) return;

    const target = (c.lastLessonId && flat.find(x => x.lessonId === c.lastLessonId)) || flat[0];
    setPlaying(target.lessonId);
  }

  function playerPrevNext(dir){
    const c = activeCourse();
    const flat = flattenLessons(c).filter(x => x.lesson.videoId);
    if (!flat.length) return;

    const idx = flat.findIndex(x => x.lessonId === playingLessonId);
    const nextIdx = idx < 0 ? 0 : (idx + dir);
    if (nextIdx < 0 || nextIdx >= flat.length) return;

    setPlaying(flat[nextIdx].lessonId);
  }

  // ---------- menus ----------
  function closeAllMenus(){
    document.querySelectorAll(".menu.open").forEach(m => m.classList.remove("open"));
  }

  function toggleMenu(menuEl){
    const isOpen = menuEl.classList.contains("open");
    closeAllMenus();
    if (!isOpen) menuEl.classList.add("open");
  }

  // ---------- rendering ----------
  function renderHeaderOnly(){
    const c = activeCourse();
    els.mainTitle.textContent = c && c.title ? c.title : "My Course";
    els.courseTitle.value = c && c.title ? c.title : "";

    const modCount = (c.modules || []).length;
    const lessonCount = flattenLessons(c).length;
    els.statsPill.textContent = `${modCount} module${modCount===1?"":"s"} â€¢ ${lessonCount} lesson${lessonCount===1?"":"s"}`;

    const { pct } = courseStats(c);
    els.progressPill.textContent = `${pct}% complete`;

    // module select
    els.moduleSelect.innerHTML = "";
    (c.modules || []).forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.title || "Module";
      els.moduleSelect.appendChild(opt);
    });

    // empty state
    els.empty.style.display = flattenLessons(c).length ? "none" : "block";
  }

  function renderSidebarOnly(){
    const q = (els.courseSearch.value || "").toLowerCase();
    const courses = (lib.courses || []).filter(c => (c.title || "").toLowerCase().includes(q));

    els.courseList.innerHTML = "";
    els.libraryMeta.textContent = `${lib.courses.length} course${lib.courses.length===1?"":"s"}`;

    courses.forEach(c => {
      const modCount = (c.modules || []).length;
      const lessonCount = flattenLessons(c).length;
      const { total, done, pct } = courseStats(c);

      const row = document.createElement("div");
      row.className = "courseRow" + (c.id === lib.activeId ? " active" : "");

      row.innerHTML = `
        <div class="courseLeft">
          <div class="courseName">${escapeHtml(c.title || "Untitled course")}</div>

          <div class="courseMeta">
            <span class="chip">${modCount} module${modCount===1?"":"s"}</span>
            <span class="chip">${lessonCount} lesson${lessonCount===1?"":"s"}</span>
          </div>

          <div class="progressWrap" title="${done}/${total} lessons complete">
            <div class="bar"><div style="width:${pct}%;"></div></div>
            <div>${pct}%</div>
          </div>
        </div>

        <div class="menuWrap">
          <button class="kebab" data-act="menuBtn" title="Course actions">â‹¯</button>
          <div class="menu" data-act="menu">
            <button data-act="rename">Rename</button>
            <button data-act="duplicate">Duplicate</button>
            <button class="danger" data-act="delete">Delete</button>
          </div>
        </div>
      `;

      row.addEventListener("click", (e) => {
        const clickedMenu = e.target.closest('[data-act="menuBtn"]') || e.target.closest('[data-act="menu"]');
        if (clickedMenu) return;
        switchCourse(c.id);
      });

      const menuBtn = row.querySelector('[data-act="menuBtn"]');
      const menu = row.querySelector('[data-act="menu"]');

      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleMenu(menu);
      });
      menu.addEventListener("click", (e) => e.stopPropagation());

      row.querySelector('[data-act="rename"]').addEventListener("click", () => {
        closeAllMenus();
        renameCourse(c.id);
      });
      row.querySelector('[data-act="duplicate"]').addEventListener("click", () => {
        closeAllMenus();
        duplicateCourse(c.id);
      });
      row.querySelector('[data-act="delete"]').addEventListener("click", () => {
        closeAllMenus();
        deleteCourse(c.id);
      });

      els.courseList.appendChild(row);
    });
  }

  function renderPlayerOnly(){
    const c = activeCourse();
    const flat = flattenLessons(c).filter(x => x.lesson.videoId);

    els.playerList.innerHTML = "";

    if (!flat.length){
      els.playerSub.textContent = "Pick a lesson to start watching.";
      els.prevBtn.classList.add("miniDisabled");
      els.nextBtn.classList.add("miniDisabled");

      els.playerFrame.innerHTML = "";
      const empty = document.createElement("div");
      empty.className = "playerEmpty";
      empty.textContent = "Add a lesson with a valid YouTube link, then click it below to watch here.";
      els.playerFrame.appendChild(empty);

      if (els.playerNotes) els.playerNotes.style.display = "none";
      return;
    }

    let idx = flat.findIndex(x => x.lessonId === playingLessonId);
    if (idx < 0) idx = c.lastLessonId ? flat.findIndex(x => x.lessonId === c.lastLessonId) : -1;
    if (idx < 0) idx = 0;

    const current = flat[idx];
    const lessonTitle = (current.lesson.title || "Lesson").trim() || "Lesson";

    const doneMark = current.lesson.completed ? "âœ… Completed" : "Not completed";
    const bronze = current.lesson.watched ? "ðŸ¥‰" : "â€”";
    const silver = current.lesson.understood ? "ðŸ¥ˆ" : "â€”";

    els.playerSub.innerHTML = `
      <span class="mono">${idx + 1} of ${flat.length}</span>
      <span>â€”</span>
      <span>${escapeHtml(lessonTitle)}</span>
      <span>â€¢</span>
      <span>${doneMark}</span>
      <span>â€¢</span>
      <span title="Rewards">${bronze} ${silver}</span>
      <span>â€¢</span>
      <a class="link" href="${escapeAttr(ytWatch(current.lesson.videoId))}" target="_blank" rel="noreferrer">Open on YouTube</a>
    `;

    if (idx <= 0) els.prevBtn.classList.add("miniDisabled"); else els.prevBtn.classList.remove("miniDisabled");
    if (idx >= flat.length - 1) els.nextBtn.classList.add("miniDisabled"); else els.nextBtn.classList.remove("miniDisabled");

    els.playerFrame.innerHTML = `
      <iframe
        title="YouTube player"
        src="${escapeAttr(ytEmbed(current.lesson.videoId))}"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen></iframe>
    `;

    if (els.playerNotes){
      els.playerNotes.style.display = "grid";
      if (els.bronzeText) els.bronzeText.textContent = current.lesson.watched ? "Earned" : "Not earned";
      if (els.silverText) els.silverText.textContent = current.lesson.understood ? "Earned" : "Not earned";

      if (els.understandBtn){
        if (current.lesson.understood){
          els.understandBtn.textContent = "Understood âœ“";
          els.understandBtn.classList.add("miniDisabled");
        } else {
          els.understandBtn.textContent = "I understand this";
          els.understandBtn.classList.remove("miniDisabled");
        }

        els.understandBtn.onclick = () => {
          if (current.lesson.understood) return;
          updateLesson(current.moduleId, current.lessonId, { understood: true });
        };
      }

      if (els.notesBox){
        els.notesBox.value = current.lesson.notes || "";
        els.notesBox.oninput = (e) => {
          const val = e.target.value;
          if (els.notesMeta) els.notesMeta.textContent = "Savingâ€¦";

          if (notesTimer) clearTimeout(notesTimer);
          notesTimer = setTimeout(() => {
            updateLesson(current.moduleId, current.lessonId, { notes: val });
            if (els.notesMeta) els.notesMeta.textContent = "Notes are saved automatically.";
          }, 250);
        };
      }
    }

    flat.forEach((x, i) => {
      const item = document.createElement("div");
      const active = x.lessonId === current.lessonId;
      item.className = "lessonPick" + (active ? " active" : "");

      const state = x.lesson.completed ? "âœ“" : "â€¢";
      const b = x.lesson.watched ? "ðŸ¥‰" : "";
      const s = x.lesson.understood ? "ðŸ¥ˆ" : "";
      const rewards = (b || s) ? `${b}${b && s ? " " : ""}${s}` : "â€”";

      const label = `${state} ${i + 1}. ${x.lesson.title || "Lesson"}`;

      item.innerHTML = `
        <div class="lessonPickLeft" style="min-width:0;">
          <div class="lessonPickTitle">${escapeHtml(label)}</div>
          <div class="lessonPickMeta">
            <span class="chip">${escapeHtml(x.moduleTitle || "Module")}</span>
            <span class="mono">ID: ${escapeHtml(x.lesson.videoId)}</span>
            <span class="chip" title="Rewards">${escapeHtml(rewards)}</span>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="miniLine" title="Mark completed">
            <input type="checkbox" ${x.lesson.completed ? "checked" : ""} data-act="done" />
            <span>Done</span>
          </label>
          <button class="miniBtn miniPrimary" data-act="play">Play</button>
        </div>
      `;

      item.querySelector('[data-act="play"]').addEventListener("click", (e) => {
        e.stopPropagation();
        playingLessonId = x.lessonId;
        setPlaying(x.lessonId);
      });

      item.querySelector('[data-act="done"]').addEventListener("change", (e) => {
        e.stopPropagation();
        updateLesson(x.moduleId, x.lessonId, { completed: !!e.target.checked });
      });

      item.addEventListener("click", () => setPlaying(x.lessonId));
      els.playerList.appendChild(item);
    });

    playingLessonId = current.lessonId;
    lib.courses = lib.courses.map(course => course.id === lib.activeId ? { ...course, lastLessonId: current.lessonId } : course);
    localStorage.setItem(LIB_KEY, JSON.stringify(lib));
  }

  function render(){
    renderHeaderOnly();
    renderSidebarOnly();
    renderPlayerOnly();

    const c = activeCourse();
    els.modules.innerHTML = "";

    (c.modules || []).forEach((m, mi) => {
      const wrap = document.createElement("div");
      wrap.className = "module";

      wrap.innerHTML = `
        <div class="moduleTop">
          <div class="moduleTopLeft">
            <div class="moduleTitle">${escapeHtml(m.title || "Module")}</div>
            <span class="chip">${(m.lessons||[]).length} lesson${(m.lessons||[]).length===1?"":"s"}</span>
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap; justify-content:flex-end;">
            <button class="iconBtn" data-act="up">â†‘</button>
            <button class="iconBtn" data-act="down">â†“</button>
            <button class="iconBtn" data-act="rename">Rename</button>
            <button class="iconBtn danger" data-act="delete">Delete</button>
          </div>
        </div>

        <div class="moduleBody" data-body="body"></div>
      `;

      wrap.querySelector('[data-act="up"]').addEventListener("click", () => moveModule(m.id, -1));
      wrap.querySelector('[data-act="down"]').addEventListener("click", () => moveModule(m.id, +1));
      wrap.querySelector('[data-act="rename"]').addEventListener("click", () => {
        const title = prompt("Rename module", m.title || "");
        if (title == null) return;
        updateModuleTitle(m.id, title.trim() || "Module");
      });
      wrap.querySelector('[data-act="delete"]').addEventListener("click", async () => {
        const ok = await confirmModal("Delete module?", `Delete "${m.title}" and its lessons?`, "Delete");
        if (!ok) return;
        removeModule(m.id);
      });

      const body = wrap.querySelector('[data-body="body"]');

      if (!(m.lessons || []).length){
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No lessons yet. Paste YouTube links above to add lessons to this module.";
        body.appendChild(empty);
      }else{
        (m.lessons || []).forEach((l, li) => {
          const row = document.createElement("div");
          row.className = "lessonRow";

          const rewardBadge = `${l.watched ? "ðŸ¥‰" : ""}${l.understood ? " ðŸ¥ˆ" : ""}`.trim() || "â€”";

          row.innerHTML = `
            <div class="lessonRowLeft">
              <label class="miniLine" title="Mark completed">
                <input type="checkbox" ${l.completed ? "checked" : ""} data-act="done" />
                <span>Done</span>
              </label>

              <div style="min-width:0;">
                <div class="lessonRowTitle">${escapeHtml(l.title || "Lesson")}</div>
                <div class="lessonRowSub">
                  <span class="chip">Rewards: ${escapeHtml(rewardBadge)}</span>
                  <a class="link" href="${escapeAttr(ytWatch(l.videoId||""))}" target="_blank" rel="noreferrer">YouTube</a>
                  <span class="mono">${escapeHtml(l.videoId || "")}</span>
                </div>
              </div>
            </div>

            <div class="lessonActions">
              <button class="iconBtn" data-act="up">â†‘</button>
              <button class="iconBtn" data-act="down">â†“</button>
              <button class="iconBtn" data-act="watch">Watch</button>
              <button class="iconBtn" data-act="edit">Edit</button>
              <button class="iconBtn danger" data-act="del">Delete</button>
            </div>
          `;

          row.querySelector('[data-act="done"]').addEventListener("change", (e) => {
            updateLesson(m.id, l.id, { completed: !!e.target.checked });
          });

          row.querySelector('[data-act="up"]').addEventListener("click", () => moveLesson(m.id, li, -1));
          row.querySelector('[data-act="down"]').addEventListener("click", () => moveLesson(m.id, li, +1));
          row.querySelector('[data-act="watch"]').addEventListener("click", () => setPlaying(l.id));

          row.querySelector('[data-act="edit"]').addEventListener("click", () => {
            const title = prompt("Lesson title", l.title || "");
            if (title == null) return;
            const url = prompt("YouTube URL", l.url || "");
            if (url == null) return;
            const vid = extractVideoId(url);
            updateLesson(m.id, l.id, { title: title.trim() || "Lesson", url: url.trim(), videoId: vid || "" });
          });

          row.querySelector('[data-act="del"]').addEventListener("click", async () => {
            const ok = await confirmModal("Delete lesson?", `Delete "${l.title}"?`, "Delete");
            if (!ok) return;
            removeLesson(m.id, l.id);
          });

          body.appendChild(row);
        });
      }

      // add quick lesson
      const addWrap = document.createElement("div");
      addWrap.className = "lessonRow";
      addWrap.innerHTML = `
        <div class="lessonRowLeft">
          <div class="lessonRowTitle">+ Add blank lesson</div>
          <div class="lessonRowSub">Creates an empty lesson you can edit.</div>
        </div>
        <div class="lessonActions">
          <button class="iconBtn miniPrimary" data-act="add">Add</button>
        </div>
      `;
      addWrap.querySelector('[data-act="add"]').addEventListener("click", () => {
        const newLesson = { id: uid(), videoId: "", url: "", title: "New lesson", completed: false, watched: false, understood: false, notes: "" };
        lib.courses = lib.courses.map(course => {
          if (course.id !== lib.activeId) return course;
          return { ...course, modules: (course.modules || []).map(mm => mm.id === m.id ? { ...mm, lessons: [...(mm.lessons || []), newLesson] } : mm) };
        });
        saveLib();
      });
      body.appendChild(addWrap);

      els.modules.appendChild(wrap);
    });
  }

  // ---------- wire up ----------
  els.newCourseBtn.addEventListener("click", newCourse);
  els.exportLibraryBtn.addEventListener("click", exportLibrary);
  els.importLibraryBtn.addEventListener("click", importLibrary);

  els.courseTitle.addEventListener("input", (e) => updateCourseTitle(e.target.value));

  els.addBtn.addEventListener("click", () => addLessonsToModule(els.moduleSelect.value));
  els.addModuleBtn.addEventListener("click", addModule);

  els.startWatchingBtn.addEventListener("click", resume);

  els.prevBtn.addEventListener("click", () => playerPrevNext(-1));
  els.nextBtn.addEventListener("click", () => playerPrevNext(+1));

  els.exportCourseBtn.addEventListener("click", () => {
    const c = activeCourse();
    const blob = new Blob([JSON.stringify(c, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${(c.title || "course").replaceAll(/[^a-z0-9]+/gi, "_").toLowerCase()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  els.deleteCourseBtn.addEventListener("click", () => deleteCourse(lib.activeId));

  document.addEventListener("click", () => closeAllMenus());
  els.courseSearch.addEventListener("input", renderSidebarOnly);

  // ---------- init ----------
  render();
</script>
</body>
</html>
